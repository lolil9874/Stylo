<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Voice Workflow - Deepgram + Prompt Enhancer</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .workflow-step {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .workflow-step.active {
            border-color: #007bff;
            background: #e3f2fd;
        }
        
        .workflow-step.success {
            border-color: #28a745;
            background: #e8f5e8;
        }
        
        .workflow-step.error {
            border-color: #dc3545;
            background: #ffeaea;
        }
        
        .step-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .step-content {
            margin-top: 10px;
        }
        
        .main-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .main-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .main-button.recording {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .text-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .config-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .config-input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Voice Workflow - Deepgram + Prompt Enhancer</h1>
        
        <div class="config-section">
            <h3>Configuration</h3>
            <input type="text" id="deepgram-key" class="config-input" placeholder="Cl√© API Deepgram" value="af9416509c6bf8b512b3fdced8233395fbd3e52b">
            <input type="text" id="deepgram-lang" class="config-input" placeholder="Langue (fr, en, etc.)" value="fr">
            <input type="text" id="supabase-key" class="config-input" placeholder="Cl√© Supabase (optionnel)" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZreWZkdW5sYnB6d3hyeXFveXBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzNTQ3OTUsImV4cCI6MjA3NjkzMDc5NX0.Qnduuj9IwhWtrOueYmBJP5nOCUS_XimrBZuvNcfT530">
        </div>
        
        <button id="main-btn" class="main-button">üé§ Cliquer pour commencer l'√©coute</button>
        
        <div class="workflow-step" id="step-1">
            <div class="step-title">1Ô∏è‚É£ √âcoute avec Deepgram</div>
            <div class="step-content">
                <div class="text-display" id="transcript">Votre parole sera transcrite ici...</div>
                <div class="status info" id="step1-status" style="display: none;">En attente...</div>
            </div>
        </div>
        
        <div class="workflow-step" id="step-2">
            <div class="step-title">2Ô∏è‚É£ Am√©lioration du Prompt</div>
            <div class="step-content">
                <div class="text-display" id="enhanced-text">Le texte am√©lior√© appara√Ætra ici...</div>
                <div class="status info" id="step2-status" style="display: none;">En attente...</div>
            </div>
        </div>
        
        <div class="workflow-step" id="step-3">
            <div class="step-title">3Ô∏è‚É£ R√©sultat Final</div>
            <div class="step-content">
                <div class="text-display" id="final-result">Le r√©sultat final sera affich√© ici...</div>
                <div class="status info" id="step3-status" style="display: none;">En attente...</div>
            </div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        // Variables globales
        let isRecording = false;
        let deepgramSocket = null;
        let audioContext = null;
        let processor = null;
        let stream = null;
        let finalText = '';
        let interimText = '';
        let recordingTimeout = null;
        
        // Fonctions utilitaires
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStep(stepId, status, message = '') {
            const step = document.getElementById(stepId);
            const statusDiv = document.getElementById(`step${stepId.split('-')[1]}-status`);
            
            step.className = `workflow-step ${status}`;
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.style.display = message ? 'block' : 'none';
            }
        }
        
        function updateMainButton(text, recording = false) {
            const btn = document.getElementById('main-btn');
            btn.textContent = text;
            btn.disabled = false; // Toujours activ√© pour pouvoir arr√™ter
            if (recording) {
                btn.classList.add('recording');
            } else {
                btn.classList.remove('recording');
            }
        }
        
        // Fonction principale du workflow
        async function startWorkflow() {
            try {
                log('üöÄ D√©marrage du workflow complet...', 'info');
                
                // √âtape 1: √âcoute avec Deepgram
                updateStep('step-1', 'active', 'D√©marrage de l\'√©coute...');
                const transcript = await startDeepgramListening();
                
                // √âtape 2: Am√©lioration du prompt
                updateStep('step-1', 'success', 'Transcription termin√©e');
                updateStep('step-2', 'active', 'Am√©lioration en cours...');
                const enhancedText = await enhancePrompt(transcript);
                
                // √âtape 3: R√©sultat final
                updateStep('step-2', 'success', 'Am√©lioration termin√©e');
                updateStep('step-3', 'success', 'Workflow termin√© avec succ√®s');
                
                // Afficher le r√©sultat final
                document.getElementById('final-result').textContent = enhancedText;
                
                log('‚úÖ Workflow termin√© avec succ√®s!', 'success');
                
            } catch (error) {
                log(`‚ùå Erreur dans le workflow: ${error.message}`, 'error');
                updateStep('step-1', 'error', 'Erreur');
                updateStep('step-2', 'error', 'Erreur');
                updateStep('step-3', 'error', 'Erreur');
            } finally {
                updateMainButton('üé§ Cliquer pour recommencer', false);
                isRecording = false;
            }
        }
        
        // Fonction d'√©coute Deepgram
        async function startDeepgramListening() {
            return new Promise(async (resolve, reject) => {
                try {
                    const apiKey = document.getElementById('deepgram-key').value;
                    const language = document.getElementById('deepgram-lang').value;
                    
                    if (!apiKey) {
                        throw new Error('Cl√© API Deepgram requise');
                    }
                    
                    // Demander l'acc√®s au microphone
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    
                    log('‚úÖ Acc√®s microphone accord√©', 'success');
                    
                    // Initialiser la connexion Deepgram
                    await initializeDeepgramConnection(apiKey, language);
                    
                    // D√©marrer le streaming audio
                    startAudioStreaming();
                    
                    isRecording = true;
                    updateMainButton('‚èπÔ∏è Arr√™ter l\'√©coute', true);
                    updateStep('step-1', 'active', 'üéôÔ∏è √âcoute en cours - Parlez maintenant...');
                    
                    // Timeout automatique apr√®s 30 secondes
                    recordingTimeout = setTimeout(() => {
                        if (isRecording) {
                            log('‚è∞ Timeout - arr√™t automatique apr√®s 30 secondes', 'info');
                            stopListening();
                            resolve(finalText.trim() || 'Aucune parole d√©tect√©e');
                        }
                    }, 30000);
                    
                    // Attendre la transcription finale
                    const checkForFinalText = setInterval(() => {
                        if (finalText.trim() && !isRecording) {
                            clearInterval(checkForFinalText);
                            if (recordingTimeout) {
                                clearTimeout(recordingTimeout);
                            }
                            resolve(finalText.trim());
                        }
                    }, 100);
                    
                } catch (error) {
                    log(`‚ùå Erreur Deepgram: ${error.message}`, 'error');
                    reject(error);
                }
            });
        }
        
        async function initializeDeepgramConnection(apiKey, language) {
            const deepgramUrl = `wss://api.deepgram.com/v1/listen?model=nova-2&smart_format=true&punctuate=true&diarize=false&language=${language}&encoding=linear16&sample_rate=16000`;
            
            deepgramSocket = new WebSocket(deepgramUrl, ['token', apiKey]);
            
            deepgramSocket.onopen = function() {
                log('üîó Connexion Deepgram WebSocket √©tablie', 'success');
            };
            
            deepgramSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.channel && data.channel.alternatives && data.channel.alternatives[0]) {
                    const transcript = data.channel.alternatives[0].transcript;
                    if (transcript) {
                        updateDeepgramTranscript(transcript, data.is_final);
                    }
                }
            };
            
            deepgramSocket.onerror = function(error) {
                log(`‚ùå Erreur WebSocket Deepgram: ${error}`, 'error');
                updateStep('step-1', 'error', 'Erreur de connexion');
            };
            
            deepgramSocket.onclose = function() {
                log('üîå Connexion Deepgram ferm√©e', 'info');
            };
        }
        
        function startAudioStreaming() {
            audioContext = new AudioContext({ sampleRate: 16000 });
            const source = audioContext.createMediaStreamSource(stream);
            processor = audioContext.createScriptProcessor(4096, 1, 1);
            
            processor.onaudioprocess = function(event) {
                if (deepgramSocket && deepgramSocket.readyState === WebSocket.OPEN) {
                    const audioData = event.inputBuffer.getChannelData(0);
                    const pcmData = convertFloat32ToPCM16(audioData);
                    deepgramSocket.send(pcmData);
                }
            };
            
            source.connect(processor);
            processor.connect(audioContext.destination);
            
            log('üéµ Streaming audio Deepgram d√©marr√©', 'info');
        }
        
        function convertFloat32ToPCM16(float32Array) {
            const buffer = new ArrayBuffer(float32Array.length * 2);
            const view = new DataView(buffer);
            let offset = 0;
            for (let i = 0; i < float32Array.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, float32Array[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
            return buffer;
        }
        
        function updateDeepgramTranscript(transcript, isFinal) {
            if (isFinal) {
                finalText += transcript + ' ';
                interimText = '';
                log(`üìù Transcription finale: "${transcript}"`, 'success');
            } else {
                interimText = transcript;
                log(`üìù Transcription partielle: "${transcript}"`, 'info');
            }
            
            const displayText = finalText + interimText;
            document.getElementById('transcript').textContent = displayText;
        }
        
        // Fonction d'am√©lioration de prompt
        async function enhancePrompt(text) {
            try {
                log('ü§ñ Tentative d\'am√©lioration du prompt...', 'info');
                
                const supabaseKey = document.getElementById('supabase-key').value;
                const enhanceUrl = 'https://vkyfdunlbpzwxryqoype.supabase.co/functions/v1/enhance-promptv2';
                
                log(`üîë Utilisation de la cl√©: ${supabaseKey.substring(0, 20)}...`, 'info');
                
                const response = await fetch(enhanceUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${supabaseKey}`
                    },
                    body: JSON.stringify({
                        input: text,
                        text: text,
                        mode: 'voice',
                        profile: {
                            role: 'user',
                            audience: 'general',
                            tone: 'professional',
                            language: 'auto',
                            constraints: []
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const enhancedText = data.enhanced || data.output || data.result || data.enhanced_text || text;
                
                // Afficher le texte am√©lior√©
                document.getElementById('enhanced-text').textContent = enhancedText;
                log('‚úÖ Texte am√©lior√© re√ßu', 'success');
                
                return enhancedText;
                
            } catch (error) {
                log(`‚ùå Erreur am√©lioration: ${error.message}`, 'error');
                log('üìã Utilisation du texte original (copi√© dans le presse-papier)', 'info');
                
                // En cas d'erreur, copier le texte original dans le presse-papier
                await copyToClipboard(text);
                
                // Afficher le texte original comme "am√©lior√©"
                document.getElementById('enhanced-text').textContent = text;
                
                return text;
            }
        }
        
        // Fonction pour copier dans le presse-papier
        async function copyToClipboard(text) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    log('‚úÖ Texte copi√© dans le presse-papier', 'success');
                } else {
                    // Fallback pour les navigateurs plus anciens
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    textArea.remove();
                    log('‚úÖ Texte copi√© dans le presse-papier (fallback)', 'success');
                }
            } catch (error) {
                log(`‚ùå Erreur copie presse-papier: ${error.message}`, 'error');
            }
        }
        
        // Fonction pour arr√™ter l'√©coute
        function stopListening() {
            log('‚èπÔ∏è Arr√™t de l\'√©coute...', 'info');
            
            // Arr√™ter l'enregistrement
            isRecording = false;
            
            // Nettoyer le timeout
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            // Fermer la connexion Deepgram
            if (deepgramSocket) {
                deepgramSocket.close();
                deepgramSocket = null;
            }
            
            // Arr√™ter le stream audio
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Fermer l'audio context
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Nettoyer le processeur
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            
            // Mettre √† jour l'interface
            updateMainButton('üé§ Cliquer pour recommencer', false);
            updateStep('step-1', 'success', '√âcoute arr√™t√©e');
            
            log('‚úÖ √âcoute arr√™t√©e avec succ√®s', 'success');
        }
        
        // Initialisation
        function init() {
            // Event listener pour le bouton principal
            document.getElementById('main-btn').addEventListener('click', function() {
                if (isRecording) {
                    stopListening();
                } else {
                    // R√©initialiser les √©tapes
                    updateStep('step-1', '', '');
                    updateStep('step-2', '', '');
                    updateStep('step-3', '', '');
                    document.getElementById('transcript').textContent = 'Votre parole sera transcrite ici...';
                    document.getElementById('enhanced-text').textContent = 'Le texte am√©lior√© appara√Ætra ici...';
                    document.getElementById('final-result').textContent = 'Le r√©sultat final sera affich√© ici...';
                    finalText = '';
                    interimText = '';
                    
                    startWorkflow();
                }
            });
            
            log('üöÄ Voice Workflow initialis√©', 'info');
        }
        
        // D√©marrer quand la page est charg√©e
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
